<div class="service-detail-container" *ngIf="!loading && service">
  <!-- Header -->
  <div class="service-header">
    <button class="back-btn" routerLink="/services">
      ‚Üê Back to Services
    </button>
    <button class="favorite-btn" (click)="toggleFavorite()" [class.active]="isFavorite">
      {{ isFavorite ? '‚ù§Ô∏è' : 'ü§ç' }} {{ isFavorite ? 'Saved' : 'Save' }}
    </button>
  </div>

  <!-- Image Gallery -->
  <div class="image-gallery" *ngIf="service.images && service.images.length > 0">
    <div class="main-image">
      <img [src]="service.images[currentImageIndex]" [alt]="getServiceName()" />
      <button class="nav-btn prev" (click)="previousImage()" *ngIf="service.images.length > 1">‚Äπ</button>
      <button class="nav-btn next" (click)="nextImage()" *ngIf="service.images.length > 1">‚Ä∫</button>
    </div>
    <div class="thumbnail-list" *ngIf="service.images.length > 1">
      <img
        *ngFor="let img of service.images; let i = index"
        [src]="img"
        [class.active]="i === currentImageIndex"
        (click)="selectImage(i)"
      />
    </div>
  </div>

  <!-- Service Info -->
  <div class="service-info">
    <div class="service-main">
      <h1>{{ getServiceName() }}</h1>
      <div class="rating">
        <span class="stars">
          <span *ngFor="let filled of getStarArray(service.averageRating)" [class.filled]="filled">‚òÖ</span>
        </span>
        <span class="rating-text">{{ service.averageRating.toFixed(1) }} ({{ service.totalReviews }} reviews)</span>
      </div>
      <p class="description">{{ getServiceDescription() }}</p>

      <div class="service-details">
        <div class="detail-item">
          <span class="label">Price:</span>
          <span class="value price">{{ formatPrice(service.basePrice) }}</span>
        </div>
        <div class="detail-item">
          <span class="label">Duration:</span>
          <span class="value">{{ formatDuration(service.estimatedDurationMinutes) }}</span>
        </div>
      </div>

      <button class="book-btn" (click)="startBooking()">
        Book Now
      </button>
    </div>

    <!-- Provider Info -->
    <div class="provider-card">
      <h3>Service Provider</h3>
      <div class="provider-info">
        <div class="provider-header">
          <h4>{{ service.provider.name }}</h4>
          <span class="verified" *ngIf="service.provider.isVerified">‚úì Verified</span>
        </div>
        <div class="provider-stats">
          <div class="stat">
            <span class="stars">
              <span *ngFor="let filled of getStarArray(service.provider.rating)" [class.filled]="filled">‚òÖ</span>
            </span>
            <span>{{ service.provider.rating.toFixed(1) }}</span>
          </div>
          <div class="stat">
            <span class="label">Experience:</span>
            <span>{{ service.provider.yearsOfExperience }} years</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Reviews -->
  <div class="reviews-section" *ngIf="reviews.length > 0">
    <h2>Recent Reviews</h2>
    <div class="reviews-list">
      <div class="review-card" *ngFor="let review of reviews">
        <div class="review-header">
          <div class="reviewer-info">
            <strong>{{ review.customerName }}</strong>
            <span class="stars">
              <span *ngFor="let filled of getStarArray(review.rating)" [class.filled]="filled">‚òÖ</span>
            </span>
          </div>
          <span class="review-date">{{ formatDate(review.createdAt) }}</span>
        </div>
        <p class="review-comment">{{ review.comment }}</p>
      </div>
    </div>
  </div>
</div>

<!-- Loading State -->
<div class="loading-container" *ngIf="loading">
  <div class="spinner"></div>
  <p>Loading service details...</p>
</div>

<!-- Booking Modal -->
<div class="modal-overlay" *ngIf="showBookingModal" (click)="closeBookingModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ getBookingStepTitle() }}</h2>
      <span class="step-indicator">Step {{ getBookingStepNumber() }} of 4</span>
      <button class="close-btn" (click)="closeBookingModal()">√ó</button>
    </div>

    <div class="modal-body">
      <!-- Step 1: Date & Time -->
      <div *ngIf="bookingStep === 'datetime'" class="booking-step">
        <div class="form-group">
          <label>Select Date</label>
          <input
            type="date"
            [(ngModel)]="scheduledDate"
            [min]="getMinScheduleDate()"
            class="form-control"
          />
        </div>
        <div class="form-group">
          <label>Select Time</label>
          <input
            type="time"
            [(ngModel)]="scheduledTime"
            class="form-control"
          />
        </div>
      </div>

      <!-- Step 2: Address -->
      <div *ngIf="bookingStep === 'address'" class="booking-step">
        <div class="address-list" *ngIf="addresses.length > 0">
          <div
            *ngFor="let address of addresses"
            class="address-card"
            [class.selected]="selectedAddressId === address.addressId"
            (click)="selectedAddressId = address.addressId"
          >
            <input
              type="radio"
              [value]="address.addressId"
              [(ngModel)]="selectedAddressId"
            />
            <div class="address-info">
              <strong>{{ address.label }}</strong>
              <p>{{ formatAddress(address) }}</p>
            </div>
          </div>
        </div>
        <p *ngIf="addresses.length === 0" class="no-addresses">
          No saved addresses. Please add an address in your profile.
        </p>
      </div>

      <!-- Step 3: Promo Code -->
      <div *ngIf="bookingStep === 'promo'" class="booking-step">
        <div class="form-group">
          <label>Promo Code (Optional)</label>
          <div class="promo-input-group">
            <input
              type="text"
              [(ngModel)]="promoCode"
              placeholder="Enter promo code"
              class="form-control"
            />
            <button
              class="validate-btn"
              (click)="validatePromoCode()"
              [disabled]="validatingPromoCode"
            >
              {{ validatingPromoCode ? 'Validating...' : 'Apply' }}
            </button>
          </div>
          <p class="promo-message" [class.valid]="promoCodeValid" [class.invalid]="!promoCodeValid && promoCodeMessage">
            {{ promoCodeMessage }}
          </p>
        </div>
        <div class="price-summary">
          <div class="price-row">
            <span>Service Price:</span>
            <span>{{ formatPrice(basePrice) }}</span>
          </div>
          <div class="price-row discount" *ngIf="promoDiscount > 0">
            <span>Promo Discount:</span>
            <span>-{{ formatPrice(promoDiscount) }}</span>
          </div>
          <div class="price-row total">
            <span>Total:</span>
            <span>{{ formatPrice(totalAmount) }}</span>
          </div>
        </div>
      </div>

      <!-- Step 4: Confirm -->
      <div *ngIf="bookingStep === 'confirm'" class="booking-step">
        <div class="booking-summary">
          <h3>Booking Summary</h3>
          <div class="summary-item">
            <span class="label">Service:</span>
            <span>{{ getServiceName() }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Date & Time:</span>
            <span>{{ scheduledDate }} at {{ scheduledTime }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Address:</span>
            <span>{{ formatAddress(addresses.find(a => a.addressId === selectedAddressId)!) }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Duration:</span>
            <span>{{ formatDuration(service!.estimatedDurationMinutes) }}</span>
          </div>
          <div class="summary-item total">
            <span class="label">Total Amount:</span>
            <span class="amount">{{ formatPrice(totalAmount) }}</span>
          </div>
        </div>

        <div class="form-group">
          <label>Additional Notes (Optional)</label>
          <textarea
            [(ngModel)]="customerNotes"
            placeholder="Any special instructions or requests..."
            rows="3"
            class="form-control"
          ></textarea>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button
        class="btn btn-secondary"
        (click)="previousBookingStep()"
        *ngIf="bookingStep !== 'datetime'"
      >
        Back
      </button>
      <button
        class="btn btn-primary"
        (click)="nextBookingStep()"
        *ngIf="bookingStep !== 'confirm'"
        [disabled]="!canGoToNextStep()"
      >
        Next
      </button>
      <button
        class="btn btn-success"
        (click)="confirmBooking()"
        *ngIf="bookingStep === 'confirm'"
        [disabled]="bookingInProgress"
      >
        {{ bookingInProgress ? 'Processing...' : 'Confirm Booking' }}
      </button>
    </div>
  </div>
</div>

<!-- Review Modal -->
<div class="modal-overlay" *ngIf="showReviewForm" (click)="showReviewForm = false">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Write a Review</h2>
      <button class="close-btn" (click)="showReviewForm = false">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Rating</label>
        <div class="star-rating">
          <span
            *ngFor="let star of getRatingStars(5)"
            class="star"
            [class.filled]="star <= reviewRating"
            (click)="setReviewRating(star)"
          >‚òÖ</span>
        </div>
      </div>
      <div class="form-group">
        <label>Your Review</label>
        <textarea
          [(ngModel)]="reviewComment"
          placeholder="Share your experience..."
          rows="5"
          class="form-control"
        ></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="showReviewForm = false">Cancel</button>
      <button
        class="btn btn-primary"
        (click)="submitReview()"
        [disabled]="submittingReview"
      >
        {{ submittingReview ? 'Submitting...' : 'Submit Review' }}
      </button>
    </div>
  </div>
</div>
