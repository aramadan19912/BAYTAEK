<div class="profile-container">
  <!-- Loading State -->
  <div *ngIf="isLoadingProfile && !currentUser" class="loading-container">
    <div class="spinner"></div>
    <p>{{ 'common.loading' | translate }}</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="currentUser" class="profile-content">
    <!-- Header -->
    <div class="profile-header">
      <div class="user-info">
        <img [src]="currentUser.profileImageUrl || 'assets/images/default-avatar.png'" alt="Profile" class="profile-avatar">
        <div class="user-details">
          <h1>{{ currentUser.firstName }} {{ currentUser.lastName }}</h1>
          <p class="user-email">{{ currentUser.email }}</p>
          <p class="user-role">{{ currentUser.role }}</p>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn-primary" (click)="startEditingProfile()" *ngIf="!isEditingProfile">
          {{ 'profile.actions.editProfile' | translate }}
        </button>
      </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <button
        class="tab-btn"
        [class.active]="activeTab === 'profile'"
        (click)="switchTab('profile')">
        {{ 'profile.tabs.profile' | translate }}
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab === 'addresses'"
        (click)="switchTab('addresses')">
        {{ 'profile.tabs.addresses' | translate }}
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab === 'payment'"
        (click)="switchTab('payment')">
        {{ 'profile.tabs.payment' | translate }}
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab === 'notifications'"
        (click)="switchTab('notifications')">
        {{ 'profile.tabs.notifications' | translate }}
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab === 'security'"
        (click)="switchTab('security')">
        {{ 'profile.tabs.security' | translate }}
      </button>
      <button
        *ngIf="isProvider"
        class="tab-btn"
        [class.active]="activeTab === 'provider'"
        (click)="switchTab('provider')">
        {{ 'profile.tabs.provider' | translate }}
      </button>
    </div>

    <!-- Profile Tab -->
    <div *ngIf="activeTab === 'profile'" class="tab-content">
      <!-- View Mode -->
      <div *ngIf="!isEditingProfile" class="profile-view">
        <div class="info-card">
          <h2>{{ 'profile.personal.title' | translate }}</h2>
          <div class="info-grid">
            <div class="info-item">
              <span class="label">{{ 'profile.personal.firstName' | translate }}</span>
              <span class="value">{{ currentUser.firstName }}</span>
            </div>
            <div class="info-item">
              <span class="label">{{ 'profile.personal.lastName' | translate }}</span>
              <span class="value">{{ currentUser.lastName }}</span>
            </div>
            <div class="info-item">
              <span class="label">{{ 'profile.personal.email' | translate }}</span>
              <span class="value">{{ currentUser.email }}</span>
            </div>
            <div class="info-item">
              <span class="label">{{ 'profile.personal.phone' | translate }}</span>
              <span class="value">{{ currentUser.phoneNumber || ('common.notProvided' | translate) }}</span>
            </div>
            <div class="info-item">
              <span class="label">{{ 'profile.personal.dateOfBirth' | translate }}</span>
              <span class="value">{{ formatDate(currentUser.dateOfBirth) }}</span>
            </div>
            <div class="info-item">
              <span class="label">{{ 'profile.personal.gender' | translate }}</span>
              <span class="value">{{ currentUser.gender || ('common.notSpecified' | translate) }}</span>
            </div>
            <div class="info-item full-width">
              <span class="label">{{ 'profile.personal.bio' | translate }}</span>
              <span class="value">{{ currentUser.bio || ('profile.personal.noBio' | translate) }}</span>
            </div>
            <div class="info-item">
              <span class="label">{{ 'profile.personal.language' | translate }}</span>
              <span class="value">{{ currentUser.preferredLanguage === 'ar' ? ('common.arabic' | translate) : ('common.english' | translate) }}</span>
            </div>
            <div class="info-item">
              <span class="label">{{ 'profile.personal.memberSince' | translate }}</span>
              <span class="value">{{ formatDate(currentUser.createdAt) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Mode -->
      <div *ngIf="isEditingProfile" class="profile-edit">
        <div class="info-card">
          <h2>{{ 'profile.edit.title' | translate }}</h2>

          <!-- Profile Image Upload -->
          <div class="form-group image-upload">
            <label>{{ 'profile.edit.profileImage' | translate }}</label>
            <div class="image-preview">
              <img
                [src]="profileImagePreview || currentUser.profileImageUrl || 'assets/images/default-avatar.png'"
                alt="Profile Preview">
              <input
                type="file"
                accept="image/*"
                (change)="onProfileImageSelected($event)"
                id="profileImageInput"
                style="display: none;">
              <button type="button" class="btn btn-secondary" (click)="document.getElementById('profileImageInput').click()">
                {{ 'profile.edit.changeImage' | translate }}
              </button>
            </div>
          </div>

          <!-- Edit Form -->
          <div class="edit-form">
            <div class="form-row">
              <div class="form-group">
                <label>{{ 'profile.personal.firstName' | translate }} *</label>
                <input type="text" [(ngModel)]="profileForm.firstName" class="form-control" required>
              </div>
              <div class="form-group">
                <label>{{ 'profile.personal.lastName' | translate }} *</label>
                <input type="text" [(ngModel)]="profileForm.lastName" class="form-control" required>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>{{ 'profile.personal.phone' | translate }} *</label>
                <input type="tel" [(ngModel)]="profileForm.phoneNumber" class="form-control" required>
              </div>
              <div class="form-group">
                <label>{{ 'profile.personal.dateOfBirth' | translate }}</label>
                <input type="date" [(ngModel)]="profileForm.dateOfBirth" class="form-control">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>{{ 'profile.personal.gender' | translate }}</label>
                <select [(ngModel)]="profileForm.gender" class="form-control">
                  <option value="">{{ 'profile.edit.selectGender' | translate }}</option>
                  <option value="Male">{{ 'profile.edit.male' | translate }}</option>
                  <option value="Female">{{ 'profile.edit.female' | translate }}</option>
                  <option value="Other">{{ 'profile.edit.other' | translate }}</option>
                </select>
              </div>
              <div class="form-group">
                <label>{{ 'profile.personal.language' | translate }}</label>
                <select [(ngModel)]="profileForm.preferredLanguage" class="form-control">
                  <option value="en">{{ 'common.english' | translate }}</option>
                  <option value="ar">{{ 'common.arabic' | translate }}</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label>{{ 'profile.personal.bio' | translate }}</label>
              <textarea [(ngModel)]="profileForm.bio" class="form-control" rows="4"
                [placeholder]="'profile.edit.bioPlaceholder' | translate"></textarea>
            </div>

            <div class="form-actions">
              <button class="btn btn-secondary" (click)="cancelEditingProfile()" [disabled]="isLoadingProfile">
                {{ 'common.cancel' | translate }}
              </button>
              <button class="btn btn-primary" (click)="saveProfile()" [disabled]="isLoadingProfile">
                {{ isLoadingProfile ? ('common.saving' | translate) : ('profile.actions.saveChanges' | translate) }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Security Tab -->
    <div *ngIf="activeTab === 'security'" class="tab-content">
      <div class="info-card">
        <h2>{{ 'profile.security.title' | translate }}</h2>

        <div *ngIf="!isChangingPassword" class="security-actions">
          <button class="btn btn-primary" (click)="startChangingPassword()">
            {{ 'profile.security.changePassword' | translate }}
          </button>
        </div>

        <div *ngIf="isChangingPassword" class="password-form">
          <div class="form-group">
            <label>{{ 'profile.security.currentPassword' | translate }} *</label>
            <input type="password" [(ngModel)]="passwordForm.currentPassword" class="form-control" required>
          </div>

          <div class="form-group">
            <label>{{ 'profile.security.newPassword' | translate }} *</label>
            <input type="password" [(ngModel)]="passwordForm.newPassword" class="form-control" required>
            <small class="form-text">{{ 'profile.security.passwordHint' | translate }}</small>
          </div>

          <div class="form-group">
            <label>{{ 'profile.security.confirmPassword' | translate }} *</label>
            <input type="password" [(ngModel)]="passwordForm.confirmPassword" class="form-control" required>
          </div>

          <div class="form-actions">
            <button class="btn btn-secondary" (click)="cancelChangingPassword()" [disabled]="isLoadingProfile">
              {{ 'common.cancel' | translate }}
            </button>
            <button class="btn btn-primary" (click)="changePassword()" [disabled]="isLoadingProfile">
              {{ isLoadingProfile ? ('common.processing' | translate) : ('profile.security.changePassword' | translate) }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Addresses Tab -->
    <div *ngIf="activeTab === 'addresses'" class="tab-content">
      <div class="info-card">
        <div class="card-header">
          <h2>{{ 'profile.addresses.title' | translate }}</h2>
          <button class="btn btn-primary" (click)="startAddingAddress()" *ngIf="!isAddingAddress">
            {{ 'profile.addresses.addNew' | translate }}
          </button>
        </div>

        <!-- Loading -->
        <div *ngIf="isLoadingAddresses" class="loading-container">
          <div class="spinner"></div>
        </div>

        <!-- Address List -->
        <div *ngIf="!isLoadingAddresses && !isAddingAddress" class="addresses-list">
          <div *ngIf="addresses.length === 0" class="empty-state">
            <p>{{ 'profile.addresses.noAddresses' | translate }}</p>
            <button class="btn btn-primary" (click)="startAddingAddress()">{{ 'profile.addresses.addFirst' | translate }}</button>
          </div>

          <div *ngFor="let address of addresses" class="address-card">
            <div class="address-header">
              <span class="address-label" *ngIf="address.label">{{ address.label }}</span>
              <span class="badge badge-primary" *ngIf="address.isDefault">{{ 'profile.addresses.default' | translate }}</span>
            </div>
            <div class="address-details">
              <p class="address-line">{{ address.addressLine }}</p>
              <p>{{ address.city }}, {{ address.region }} {{ address.postalCode }}</p>
              <p>{{ address.country }}</p>
              <p *ngIf="address.additionalInfo" class="additional-info">{{ address.additionalInfo }}</p>
            </div>
            <div class="address-actions">
              <button class="btn btn-sm btn-secondary" (click)="editAddress(address)">{{ 'profile.addresses.edit' | translate }}</button>
              <button class="btn btn-sm btn-secondary" (click)="setDefaultAddress(address.addressId)"
                *ngIf="!address.isDefault">
                {{ 'profile.addresses.setDefault' | translate }}
              </button>
              <button class="btn btn-sm btn-danger" (click)="deleteAddress(address.addressId)">{{ 'profile.addresses.delete' | translate }}</button>
            </div>
          </div>
        </div>

        <!-- Add/Edit Address Form -->
        <div *ngIf="isAddingAddress" class="address-form">
          <h3>{{ editingAddress ? ('profile.addresses.editTitle' | translate) : ('profile.addresses.addTitle' | translate) }}</h3>

          <div class="form-group">
            <label>{{ 'profile.addresses.label' | translate }}</label>
            <input type="text" [(ngModel)]="addressForm.label" class="form-control"
              [placeholder]="'profile.addresses.labelPlaceholder' | translate">
          </div>

          <div class="form-group">
            <label>{{ 'profile.addresses.addressLine' | translate }} *</label>
            <input type="text" [(ngModel)]="addressForm.addressLine" class="form-control"
              [placeholder]="'profile.addresses.addressLinePlaceholder' | translate" required>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>{{ 'profile.addresses.city' | translate }} *</label>
              <input type="text" [(ngModel)]="addressForm.city" class="form-control" required>
            </div>
            <div class="form-group">
              <label>{{ 'profile.addresses.region' | translate }} *</label>
              <input type="text" [(ngModel)]="addressForm.region" class="form-control" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>{{ 'profile.addresses.postalCode' | translate }}</label>
              <input type="text" [(ngModel)]="addressForm.postalCode" class="form-control">
            </div>
            <div class="form-group">
              <label>{{ 'profile.addresses.country' | translate }} *</label>
              <input type="text" [(ngModel)]="addressForm.country" class="form-control" required>
            </div>
          </div>

          <div class="form-group">
            <label>{{ 'profile.addresses.additionalInfo' | translate }}</label>
            <textarea [(ngModel)]="addressForm.additionalInfo" class="form-control" rows="2"
              [placeholder]="'profile.addresses.additionalInfoPlaceholder' | translate"></textarea>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="addressForm.isDefault">
              {{ 'profile.addresses.setDefaultCheckbox' | translate }}
            </label>
          </div>

          <div class="form-actions">
            <button class="btn btn-secondary" (click)="cancelAddingAddress()" [disabled]="isLoadingAddresses">
              {{ 'common.cancel' | translate }}
            </button>
            <button class="btn btn-primary" (click)="saveAddress()" [disabled]="isLoadingAddresses">
              {{ isLoadingAddresses ? ('common.saving' | translate) : ('profile.addresses.save' | translate) }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Payment Methods Tab -->
    <div *ngIf="activeTab === 'payment'" class="tab-content">
      <div class="info-card">
        <div class="card-header">
          <h2>{{ 'profile.payment.title' | translate }}</h2>
        </div>

        <!-- Loading -->
        <div *ngIf="isLoadingPaymentMethods" class="loading-container">
          <div class="spinner"></div>
        </div>

        <!-- Payment Methods List -->
        <div *ngIf="!isLoadingPaymentMethods" class="payment-methods-list">
          <div *ngIf="paymentMethods.length === 0" class="empty-state">
            <p>{{ 'profile.payment.noMethods' | translate }}</p>
            <p class="info-text">{{ 'profile.payment.methodsInfo' | translate }}</p>
          </div>

          <div *ngFor="let method of paymentMethods" class="payment-card">
            <div class="payment-info">
              <span class="payment-icon">ðŸ’³</span>
              <div class="payment-details">
                <p class="card-info">
                  <strong>{{ method.cardBrand }} â€¢â€¢â€¢â€¢ {{ method.cardLast4 }}</strong>
                </p>
                <p class="expiry">{{ 'profile.payment.expires' | translate }} {{ method.cardExpMonth }}/{{ method.cardExpYear }}</p>
              </div>
              <span class="badge badge-primary" *ngIf="method.isDefault">{{ 'profile.payment.default' | translate }}</span>
            </div>
            <div class="payment-actions">
              <button class="btn btn-sm btn-secondary" (click)="setDefaultPaymentMethod(method.paymentMethodId)"
                *ngIf="!method.isDefault">
                {{ 'profile.payment.setDefault' | translate }}
              </button>
              <button class="btn btn-sm btn-danger" (click)="deletePaymentMethod(method.paymentMethodId)">
                {{ 'profile.payment.remove' | translate }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Notifications Tab -->
    <div *ngIf="activeTab === 'notifications'" class="tab-content">
      <div class="info-card">
        <h2>{{ 'profile.notifications.title' | translate }}</h2>

        <!-- Loading -->
        <div *ngIf="isLoadingNotificationSettings" class="loading-container">
          <div class="spinner"></div>
        </div>

        <!-- Notification Settings -->
        <div *ngIf="!isLoadingNotificationSettings" class="notification-settings">
          <div class="settings-group">
            <h3>{{ 'profile.notifications.channels' | translate }}</h3>
            <div class="setting-item">
              <label class="checkbox-label">
                <input type="checkbox" [(ngModel)]="notificationSettings.emailNotifications">
                <div class="label-text">
                  <strong>{{ 'profile.notifications.email' | translate }}</strong>
                  <p>{{ 'profile.notifications.emailDesc' | translate }}</p>
                </div>
              </label>
            </div>
            <div class="setting-item">
              <label class="checkbox-label">
                <input type="checkbox" [(ngModel)]="notificationSettings.smsNotifications">
                <div class="label-text">
                  <strong>{{ 'profile.notifications.sms' | translate }}</strong>
                  <p>{{ 'profile.notifications.smsDesc' | translate }}</p>
                </div>
              </label>
            </div>
            <div class="setting-item">
              <label class="checkbox-label">
                <input type="checkbox" [(ngModel)]="notificationSettings.pushNotifications">
                <div class="label-text">
                  <strong>{{ 'profile.notifications.push' | translate }}</strong>
                  <p>{{ 'profile.notifications.pushDesc' | translate }}</p>
                </div>
              </label>
            </div>
          </div>

          <div class="settings-group">
            <h3>{{ 'profile.notifications.types' | translate }}</h3>
            <div class="setting-item">
              <label class="checkbox-label">
                <input type="checkbox" [(ngModel)]="notificationSettings.bookingUpdates">
                <div class="label-text">
                  <strong>{{ 'profile.notifications.bookingUpdates' | translate }}</strong>
                  <p>{{ 'profile.notifications.bookingUpdatesDesc' | translate }}</p>
                </div>
              </label>
            </div>
            <div class="setting-item">
              <label class="checkbox-label">
                <input type="checkbox" [(ngModel)]="notificationSettings.reminderNotifications">
                <div class="label-text">
                  <strong>{{ 'profile.notifications.reminders' | translate }}</strong>
                  <p>{{ 'profile.notifications.remindersDesc' | translate }}</p>
                </div>
              </label>
            </div>
            <div class="setting-item">
              <label class="checkbox-label">
                <input type="checkbox" [(ngModel)]="notificationSettings.messageNotifications">
                <div class="label-text">
                  <strong>{{ 'profile.notifications.messages' | translate }}</strong>
                  <p>{{ 'profile.notifications.messagesDesc' | translate }}</p>
                </div>
              </label>
            </div>
            <div class="setting-item">
              <label class="checkbox-label">
                <input type="checkbox" [(ngModel)]="notificationSettings.reviewRequests">
                <div class="label-text">
                  <strong>{{ 'profile.notifications.reviewRequests' | translate }}</strong>
                  <p>{{ 'profile.notifications.reviewRequestsDesc' | translate }}</p>
                </div>
              </label>
            </div>
          </div>

          <div class="settings-group">
            <h3>{{ 'profile.notifications.marketing' | translate }}</h3>
            <div class="setting-item">
              <label class="checkbox-label">
                <input type="checkbox" [(ngModel)]="notificationSettings.promotionalEmails">
                <div class="label-text">
                  <strong>{{ 'profile.notifications.promotional' | translate }}</strong>
                  <p>{{ 'profile.notifications.promotionalDesc' | translate }}</p>
                </div>
              </label>
            </div>
            <div class="setting-item">
              <label class="checkbox-label">
                <input type="checkbox" [(ngModel)]="notificationSettings.newsletterSubscription">
                <div class="label-text">
                  <strong>{{ 'profile.notifications.newsletter' | translate }}</strong>
                  <p>{{ 'profile.notifications.newsletterDesc' | translate }}</p>
                </div>
              </label>
            </div>
          </div>

          <div class="form-actions">
            <button class="btn btn-primary" (click)="saveNotificationSettings()"
              [disabled]="isLoadingNotificationSettings">
              {{ isLoadingNotificationSettings ? ('common.saving' | translate) : ('profile.notifications.savePreferences' | translate) }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Provider Tab -->
    <div *ngIf="activeTab === 'provider' && isProvider" class="tab-content">
      <div class="info-card">
        <h2>{{ 'profile.provider.title' | translate }}</h2>

        <!-- Loading -->
        <div *ngIf="isLoadingProviderProfile" class="loading-container">
          <div class="spinner"></div>
        </div>

        <!-- Provider Profile -->
        <div *ngIf="!isLoadingProviderProfile && providerProfile" class="provider-info">
          <div class="verification-status">
            <span class="status-badge" [class]="getVerificationStatusClass(providerProfile.verificationStatus)">
              {{ getVerificationStatusLabel(providerProfile.verificationStatus) }}
            </span>
          </div>

          <div class="info-grid">
            <div class="info-item">
              <span class="label">{{ 'profile.provider.businessName' | translate }}</span>
              <span class="value">{{ providerProfile.businessName || ('common.notProvided' | translate) }}</span>
            </div>
            <div class="info-item">
              <span class="label">{{ 'profile.provider.businessType' | translate }}</span>
              <span class="value">{{ providerProfile.businessType || ('common.notSpecified' | translate) }}</span>
            </div>
            <div class="info-item">
              <span class="label">{{ 'profile.provider.commercialReg' | translate }}</span>
              <span class="value">{{ providerProfile.commercialRegistrationNumber || ('common.notProvided' | translate) }}</span>
            </div>
            <div class="info-item">
              <span class="label">{{ 'profile.provider.taxNumber' | translate }}</span>
              <span class="value">{{ providerProfile.taxNumber || ('common.notProvided' | translate) }}</span>
            </div>
            <div class="info-item">
              <span class="label">{{ 'profile.provider.experience' | translate }}</span>
              <span class="value">{{ providerProfile.experienceYears || 0 }} {{ 'profile.provider.years' | translate }}</span>
            </div>
            <div class="info-item">
              <span class="label">{{ 'profile.provider.serviceRegions' | translate }}</span>
              <span class="value">{{ providerProfile.serviceRegions?.join(', ') || ('common.notSpecified' | translate) }}</span>
            </div>
            <div class="info-item full-width">
              <span class="label">{{ 'profile.provider.description' | translate }}</span>
              <span class="value">{{ providerProfile.businessDescription || ('profile.provider.noDescription' | translate) }}</span>
            </div>
          </div>

          <div class="provider-stats">
            <div class="stat-card">
              <span class="stat-value">{{ providerProfile.totalServices || 0 }}</span>
              <span class="stat-label">{{ 'profile.provider.stats.totalServices' | translate }}</span>
            </div>
            <div class="stat-card">
              <span class="stat-value">{{ providerProfile.activeServices || 0 }}</span>
              <span class="stat-label">{{ 'profile.provider.stats.activeServices' | translate }}</span>
            </div>
            <div class="stat-card">
              <span class="stat-value">{{ providerProfile.totalBookings || 0 }}</span>
              <span class="stat-label">{{ 'profile.provider.stats.totalBookings' | translate }}</span>
            </div>
            <div class="stat-card">
              <span class="stat-value">{{ providerProfile.averageRating || 0 }}</span>
              <span class="stat-label">{{ 'profile.provider.stats.avgRating' | translate }}</span>
            </div>
          </div>

          <div *ngIf="providerProfile.verificationStatus === 'Rejected'" class="rejection-notice">
            <h3>{{ 'profile.provider.rejectionTitle' | translate }}</h3>
            <p>{{ providerProfile.verificationNotes }}</p>
            <p class="info-text">{{ 'profile.provider.rejectionInfo' | translate }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
