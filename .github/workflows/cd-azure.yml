name: CD - Deploy to Azure

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - '.github/workflows/cd-azure.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  DOTNET_VERSION: '8.0.x'
  AZURE_WEBAPP_NAME: 'homeservice-api'
  AZURE_RESOURCE_GROUP: 'homeservice-rg'
  ACR_NAME: 'homeserviceacr'
  IMAGE_NAME: 'homeservice-api'

jobs:
  # ================================================
  # Build and Push to Azure Container Registry
  # ================================================
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}

    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to Azure Container Registry
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.ACR_NAME }}.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:buildcache,mode=max

  # ================================================
  # Run Database Migrations
  # ================================================
  run-migrations:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: build-and-push
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install EF Core tools
        run: dotnet tool install --global dotnet-ef

      - name: Run migrations
        run: |
          cd backend/src/HomeService.API
          dotnet ef database update --connection "${{ secrets.SQL_CONNECTION_STRING }}"
        env:
          ASPNETCORE_ENVIRONMENT: ${{ github.event.inputs.environment || 'staging' }}

  # ================================================
  # Deploy to Azure App Service
  # ================================================
  deploy-app-service:
    name: Deploy to Azure App Service
    runs-on: ubuntu-latest
    needs: [build-and-push, run-migrations]
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}
      url: ${{ steps.deploy.outputs.webapp-url }}

    steps:
      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure App Service
        id: deploy
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}-${{ github.event.inputs.environment || 'staging' }}
          images: ${{ needs.build-and-push.outputs.image-tag }}

      - name: Configure App Settings
        uses: azure/appservice-settings@v1
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}-${{ github.event.inputs.environment || 'staging' }}
          app-settings-json: |
            [
              {
                "name": "ASPNETCORE_ENVIRONMENT",
                "value": "${{ github.event.inputs.environment || 'staging' }}",
                "slotSetting": false
              },
              {
                "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                "value": "${{ secrets.APPLICATIONINSIGHTS_CONNECTION_STRING }}",
                "slotSetting": false
              },
              {
                "name": "JwtSettings__SecretKey",
                "value": "${{ secrets.JWT_SECRET_KEY }}",
                "slotSetting": false
              }
            ]

  # ================================================
  # Smoke Tests
  # ================================================
  smoke-tests:
    name: Run Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy-app-service
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - name: Wait for deployment to be ready
        run: sleep 30

      - name: Health check
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.AZURE_WEBAPP_NAME }}-${{ github.event.inputs.environment || 'staging' }}.azurewebsites.net/health)
          if [ $RESPONSE -ne 200 ]; then
            echo "‚ùå Health check failed with status code: $RESPONSE"
            exit 1
          fi
          echo "‚úÖ Health check passed"

      - name: API endpoint test
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.AZURE_WEBAPP_NAME }}-${{ github.event.inputs.environment || 'staging' }}.azurewebsites.net/api/health)
          if [ $RESPONSE -ne 200 ]; then
            echo "‚ùå API health check failed with status code: $RESPONSE"
            exit 1
          fi
          echo "‚úÖ API health check passed"

  # ================================================
  # Deployment Summary
  # ================================================
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [build-and-push, run-migrations, deploy-app-service, smoke-tests]
    if: always()

    steps:
      - name: Send deployment notification
        run: |
          echo "üöÄ Deployment to ${{ github.event.inputs.environment || 'staging' }} completed"
          echo "Build and Push: ${{ needs.build-and-push.result }}"
          echo "Migrations: ${{ needs.run-migrations.result }}"
          echo "Deployment: ${{ needs.deploy-app-service.result }}"
          echo "Smoke Tests: ${{ needs.smoke-tests.result }}"

          if [ "${{ needs.build-and-push.result }}" != "success" ] || \
             [ "${{ needs.run-migrations.result }}" != "success" ] || \
             [ "${{ needs.deploy-app-service.result }}" != "success" ] || \
             [ "${{ needs.smoke-tests.result }}" != "success" ]; then
            echo "‚ùå Deployment failed"
            exit 1
          fi

          echo "‚úÖ Deployment successful!"

      - name: Post to Slack (optional)
        if: always()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "Deployment to ${{ github.event.inputs.environment || 'staging' }} ${{ needs.smoke-tests.result == 'success' && 'succeeded ‚úÖ' || 'failed ‚ùå' }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Deployment Status*\nEnvironment: ${{ github.event.inputs.environment || 'staging' }}\nStatus: ${{ needs.smoke-tests.result == 'success' && '‚úÖ Success' || '‚ùå Failed' }}\nCommit: ${{ github.sha }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
