name: Deploy to Fly.io

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

jobs:
  # Job 1: Deploy Backend to Fly.io
  deploy-backend:
    name: Deploy Backend to Fly.io
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy Backend
        run: |
          cd backend

          # Check if app exists, if not use launch, otherwise use deploy
          if ! flyctl apps list 2>/dev/null | grep -q "baytaek-api"; then
            echo "üöÄ First deployment - launching app..."

            # Launch without --org to use default organization
            flyctl launch --now \
              --name baytaek-api \
              --region fra \
              --ha=false \
              --yes \
              --copy-config \
              --no-deploy \
              --internal-port 9000

            # Create volume before first deploy
            echo "üì¶ Creating persistent volume for database..."
            flyctl volumes create baytaek_data --region fra --size 1 --app baytaek-api --yes

            # Now deploy with the configuration
            echo "üöÄ Deploying backend..."
            flyctl deploy --remote-only --ha=false
          else
            echo "‚ôªÔ∏è  App exists - deploying update..."

            # Ensure volume exists
            if ! flyctl volumes list -a baytaek-api 2>/dev/null | grep -q "baytaek_data"; then
              echo "üì¶ Creating persistent volume for database..."
              flyctl volumes create baytaek_data --region fra --size 1 --app baytaek-api --yes
            fi

            # Deploy update
            flyctl deploy --remote-only --ha=false
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Check Backend Health
        run: |
          echo "Waiting for backend to start..."
          sleep 30

          # Get backend URL
          BACKEND_URL=$(flyctl apps info baytaek-api --json | jq -r '.Hostname')
          echo "Backend URL: https://$BACKEND_URL"

          # Health check
          HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://$BACKEND_URL/health || echo "000")

          if [ "$HEALTH_STATUS" = "200" ]; then
            echo "‚úÖ Backend is healthy (HTTP $HEALTH_STATUS)"
          else
            echo "‚ö†Ô∏è  Backend health check returned HTTP $HEALTH_STATUS"
            echo "Checking logs..."
            flyctl logs -a baytaek-api --lines 50
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  # Job 2: Deploy Frontend to Fly.io
  deploy-frontend:
    name: Deploy Frontend to Fly.io
    runs-on: ubuntu-latest
    needs: deploy-backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: ./frontend/package-lock.json

      - name: Update Frontend API URL
        run: |
          cd frontend

          # Get backend URL
          BACKEND_URL="baytaek-api.fly.dev"

          # Update environment.prod.ts if it exists
          if [ -f src/environments/environment.prod.ts ]; then
            sed -i "s|apiUrl:.*|apiUrl: 'https://$BACKEND_URL/api',|g" src/environments/environment.prod.ts
            sed -i "s|signalrUrl:.*|signalrUrl: 'https://$BACKEND_URL/hubs'|g" src/environments/environment.prod.ts
            echo "‚úÖ Updated environment.prod.ts with backend URL"
          fi

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy Frontend
        run: |
          cd frontend

          # Check if app exists, if not use launch, otherwise use deploy
          if ! flyctl apps list 2>/dev/null | grep -q "baytaek-frontend"; then
            echo "üöÄ First deployment - launching app..."

            # Launch without --org to use default organization
            flyctl launch --now \
              --name baytaek-frontend \
              --region fra \
              --ha=false \
              --yes \
              --copy-config \
              --no-deploy

            # Now deploy with the configuration
            echo "üöÄ Deploying frontend..."
            flyctl deploy --remote-only --ha=false
          else
            echo "‚ôªÔ∏è  App exists - deploying update..."
            flyctl deploy --remote-only --ha=false
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Check Frontend Health
        run: |
          echo "Waiting for frontend to start..."
          sleep 20

          # Get frontend URL
          FRONTEND_URL=$(flyctl apps info baytaek-frontend --json | jq -r '.Hostname')
          echo "Frontend URL: https://$FRONTEND_URL"

          # Health check
          FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://$FRONTEND_URL || echo "000")

          if [ "$FRONTEND_STATUS" = "200" ] || [ "$FRONTEND_STATUS" = "304" ]; then
            echo "‚úÖ Frontend is accessible (HTTP $FRONTEND_STATUS)"
          else
            echo "‚ö†Ô∏è  Frontend returned HTTP $FRONTEND_STATUS"
            echo "Checking logs..."
            flyctl logs -a baytaek-frontend --lines 50
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  # Job 3: Deployment Summary
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()

    steps:
      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Get Deployment URLs
        run: |
          echo "=================================================="
          echo "           üöÄ Deployment Complete!              "
          echo "=================================================="
          echo ""

          # Get URLs
          BACKEND_URL=$(flyctl apps info baytaek-api --json | jq -r '.Hostname' 2>/dev/null || echo "baytaek-api.fly.dev")
          FRONTEND_URL=$(flyctl apps info baytaek-frontend --json | jq -r '.Hostname' 2>/dev/null || echo "baytaek-frontend.fly.dev")

          echo "üì± Application URLs:"
          echo "   Backend API:    https://$BACKEND_URL"
          echo "   Frontend:       https://$FRONTEND_URL"
          echo "   Swagger Docs:   https://$BACKEND_URL/swagger"
          echo "   Health Check:   https://$BACKEND_URL/health"
          echo ""
          echo "üìä Quick Commands:"
          echo "   Backend logs:   flyctl logs -a baytaek-api"
          echo "   Frontend logs:  flyctl logs -a baytaek-frontend"
          echo "   Backend status: flyctl status -a baytaek-api"
          echo ""
          echo "üí∞ Cost: \$0/month (Free Tier)"
          echo "=================================================="
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Send Notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment to Fly.io successful!"
          else
            echo "‚ùå Deployment to Fly.io failed!"
            echo "Check the logs above for details."
          fi
