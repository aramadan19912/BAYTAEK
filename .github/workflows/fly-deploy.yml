name: Deploy to Fly.io

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

jobs:
  # Job 1: Deploy Backend to Fly.io
  deploy-backend:
    name: Deploy Backend to Fly.io
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Launch or Deploy Backend
        working-directory: ./backend
        run: |
          # First, try a simple deploy
          set +e
          flyctl deploy --config fly.toml --ha=false 2>&1 | tee deploy_output.txt
          DEPLOY_EXIT=$?
          set -e

          # Check if app needs to be created
          if grep -q "Could not find App\|does not exist" deploy_output.txt; then
            echo "üìù Creating new app with launch..."

            # Use launch to create the app
            flyctl launch --yes --no-deploy --copy-config --name baytaek-api --region fra

            # Create volume
            flyctl volumes create baytaek_data --region fra --size 1 --yes || true

            # Now deploy
            flyctl deploy --config fly.toml --ha=false
          elif [ $DEPLOY_EXIT -ne 0 ]; then
            echo "‚ùå Deployment failed"
            cat deploy_output.txt
            exit 1
          else
            echo "‚úÖ Deployment successful"
            # Ensure volume exists
            flyctl volumes create baytaek_data --region fra --size 1 --yes 2>/dev/null || echo "Volume already exists"
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Check Backend Health
        run: |
          echo "Waiting for backend to start..."
          sleep 30

          # Backend URL is predictable on Fly.io
          BACKEND_URL="baytaek-api.fly.dev"
          echo "Backend URL: https://$BACKEND_URL"

          # Health check
          HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://$BACKEND_URL/health || echo "000")

          if [ "$HEALTH_STATUS" = "200" ]; then
            echo "‚úÖ Backend is healthy (HTTP $HEALTH_STATUS)"
          else
            echo "‚ö†Ô∏è  Backend health check returned HTTP $HEALTH_STATUS"
            echo "Checking logs..."
            flyctl logs -a baytaek-api --lines 50 || true
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  # Job 2: Deploy Frontend to Fly.io
  deploy-frontend:
    name: Deploy Frontend to Fly.io
    runs-on: ubuntu-latest
    needs: deploy-backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: ./frontend/package-lock.json

      - name: Update Frontend API URL
        run: |
          cd frontend

          # Get backend URL
          BACKEND_URL="baytaek-api.fly.dev"

          # Update environment.prod.ts if it exists
          if [ -f src/environments/environment.prod.ts ]; then
            sed -i "s|apiUrl:.*|apiUrl: 'https://$BACKEND_URL/api',|g" src/environments/environment.prod.ts
            sed -i "s|signalrUrl:.*|signalrUrl: 'https://$BACKEND_URL/hubs'|g" src/environments/environment.prod.ts
            echo "‚úÖ Updated environment.prod.ts with backend URL"
          fi

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Launch or Deploy Frontend
        working-directory: ./frontend
        run: |
          # First, try a simple deploy
          set +e
          flyctl deploy --config fly.toml --ha=false 2>&1 | tee deploy_output.txt
          DEPLOY_EXIT=$?
          set -e

          # Check if app needs to be created
          if grep -q "Could not find App\|does not exist" deploy_output.txt; then
            echo "üìù Creating new app with launch..."

            # Use launch to create the app
            flyctl launch --yes --no-deploy --copy-config --name baytaek-frontend --region fra

            # Now deploy
            flyctl deploy --config fly.toml --ha=false
          elif [ $DEPLOY_EXIT -ne 0 ]; then
            echo "‚ùå Deployment failed"
            cat deploy_output.txt
            exit 1
          else
            echo "‚úÖ Deployment successful"
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Check Frontend Health
        run: |
          echo "Waiting for frontend to start..."
          sleep 20

          # Frontend URL is predictable on Fly.io
          FRONTEND_URL="baytaek-frontend.fly.dev"
          echo "Frontend URL: https://$FRONTEND_URL"

          # Health check
          FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://$FRONTEND_URL || echo "000")

          if [ "$FRONTEND_STATUS" = "200" ] || [ "$FRONTEND_STATUS" = "304" ]; then
            echo "‚úÖ Frontend is accessible (HTTP $FRONTEND_STATUS)"
          else
            echo "‚ö†Ô∏è  Frontend returned HTTP $FRONTEND_STATUS"
            echo "Checking logs..."
            flyctl logs -a baytaek-frontend --lines 50 || true
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  # Job 3: Deployment Summary
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()

    steps:
      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Get Deployment URLs
        run: |
          echo "=================================================="
          echo "           üöÄ Deployment Complete!              "
          echo "=================================================="
          echo ""

          # Fly.io URLs are predictable
          BACKEND_URL="baytaek-api.fly.dev"
          FRONTEND_URL="baytaek-frontend.fly.dev"

          echo "üì± Application URLs:"
          echo "   Backend API:    https://$BACKEND_URL"
          echo "   Frontend:       https://$FRONTEND_URL"
          echo "   Swagger Docs:   https://$BACKEND_URL/swagger"
          echo "   Health Check:   https://$BACKEND_URL/health"
          echo ""
          echo "üìä Quick Commands:"
          echo "   Backend logs:   flyctl logs -a baytaek-api"
          echo "   Frontend logs:  flyctl logs -a baytaek-frontend"
          echo "   Backend status: flyctl status -a baytaek-api"
          echo ""
          echo "üí∞ Cost: \$0/month (Free Tier)"
          echo "=================================================="
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Send Notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment to Fly.io successful!"
          else
            echo "‚ùå Deployment to Fly.io failed!"
            echo "Check the logs above for details."
          fi
