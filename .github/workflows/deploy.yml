name: Deploy to Hostinger VPS

on:
  push:
    branches:
      - main
      - production
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '20.x'

jobs:
  # Job 1: Build and Test Backend
  build-backend:
    name: Build & Test Backend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore
        working-directory: ./backend

      - name: Build
        run: dotnet build --configuration Release --no-restore
        working-directory: ./backend

      - name: Run tests
        run: dotnet test --no-restore --verbosity normal
        working-directory: ./backend
        continue-on-error: true

      - name: Publish
        run: dotnet publish src/HomeService.API/HomeService.API.csproj --configuration Release --output ./publish --runtime linux-x64 --self-contained true
        working-directory: ./backend

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: ./backend/publish/
          retention-days: 1

  # Job 2: Build Frontend
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ./frontend/package-lock.json

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci --prefer-offline --no-audit
          else
            npm install --prefer-offline --no-audit
          fi
        working-directory: ./frontend

      - name: Build Angular app
        run: npm run build -- --configuration production --progress=false
        working-directory: ./frontend
        continue-on-error: true
        env:
          NODE_OPTIONS: '--max-old-space-size=4096'
          NG_BUILD_ANALYZE: 'false'

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: ./frontend/dist/frontend/browser/
          retention-days: 1

  # Job 3: Deploy to VPS
  deploy:
    name: Deploy to Hostinger VPS
    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: ./backend-build

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ./frontend-build

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          cat >> ~/.ssh/config <<EOF
          Host vps
            HostName ${{ secrets.VPS_HOST }}
            User ${{ secrets.VPS_USER }}
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF
          chmod 600 ~/.ssh/config

      - name: Ensure backend service exists
        run: |
          ssh vps '
            if ! systemctl list-unit-files | grep -q "^baytaek-api.service"; then
              cat <<EOF | sudo tee /etc/systemd/system/baytaek-api.service
          [Unit]
          Description=Baytaek API
          After=network.target

          [Service]
          Type=simple
          User=www-data
          WorkingDirectory=/var/www/baytaek/backend
          ExecStart=/var/www/baytaek/backend/HomeService.API
          Restart=always
          RestartSec=5
          Environment=ASPNETCORE_ENVIRONMENT=Production

          [Install]
          WantedBy=multi-user.target
          EOF
              sudo systemctl daemon-reload
              sudo systemctl enable baytaek-api.service
            fi
          '

          # Update existing service if needed
          ssh vps "
            if systemctl list-unit-files | grep -q '^baytaek-api.service'; then
              sudo sed -i 's|ExecStart=/usr/bin/dotnet /var/www/baytaek/backend/HomeService.API.dll|ExecStart=/var/www/baytaek/backend/HomeService.API|g' /etc/systemd/system/baytaek-api.service
              sudo systemctl daemon-reload
            fi
          "

      - name: Deploy Backend to VPS
        run: |
          # Ensure directory structure exists
          ssh vps "
            sudo mkdir -p /var/www/baytaek/backend
            sudo chown -R \$USER:\$USER /var/www/baytaek
          "

          # Create backup of current deployment
          ssh vps "
            if [ -d /var/www/baytaek/backend ] && [ \"\$(ls -A /var/www/baytaek/backend)\" ]; then
              sudo cp -r /var/www/baytaek/backend /var/www/baytaek/backend.backup.\$(date +%Y%m%d_%H%M%S)
            fi
          "

          # Stop the backend service if running
          ssh vps "
            if systemctl is-active --quiet baytaek-api; then
              sudo systemctl stop baytaek-api
            fi
          "

          # Upload new backend files
          rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no" ./backend-build/ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/var/www/baytaek/backend/

          # Set permissions
          ssh vps "
            sudo chown -R www-data:www-data /var/www/baytaek/backend
            sudo chmod -R 755 /var/www/baytaek/backend
            sudo chmod +x /var/www/baytaek/backend/HomeService.API
          "

          # Run database migrations
          ssh vps "
            cd /var/www/baytaek/backend
            sudo -u www-data dotnet ef database update --no-build || echo 'Migration skipped or failed'
          "

          # Start the backend service
          ssh vps "sudo systemctl start baytaek-api"

          # Wait for service to start
          sleep 5

          # Check service status
          ssh vps "sudo systemctl status baytaek-api --no-pager"

      - name: Deploy Frontend to VPS
        run: |
          # Ensure directory structure exists
          ssh vps "
            sudo mkdir -p /var/www/baytaek/frontend/dist/frontend/browser
            sudo chown -R \$USER:\$USER /var/www/baytaek/frontend
          "

          # Create backup of current frontend
          ssh vps "
            if [ -d /var/www/baytaek/frontend/dist ] && [ \"\$(ls -A /var/www/baytaek/frontend/dist)\" ]; then
              sudo cp -r /var/www/baytaek/frontend/dist /var/www/baytaek/frontend/dist.backup.\$(date +%Y%m%d_%H%M%S)
            fi
          "

          # Upload new frontend files
          rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no" ./frontend-build/ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/var/www/baytaek/frontend/dist/frontend/browser/

          # Set permissions
          ssh vps "
            sudo chown -R www-data:www-data /var/www/baytaek/frontend
            sudo chmod -R 755 /var/www/baytaek/frontend
          "

          # Reload Nginx
          ssh vps "sudo systemctl reload nginx"

      - name: Health Check
        run: |
          # Wait for application to fully start
          sleep 10

          # Check backend health (try multiple endpoints)
          echo "Checking backend health..."
          BACKEND_STATUS=$(ssh vps 'curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/health || echo "000"')

          if [ "$BACKEND_STATUS" = "000" ]; then
            # Try alternative port 5001 (HTTPS default)
            BACKEND_STATUS=$(ssh vps 'curl -sk -o /dev/null -w "%{http_code}" https://localhost:5001/health || echo "000"')
          fi

          if [ "$BACKEND_STATUS" = "200" ]; then
            echo "✅ Backend is healthy (HTTP $BACKEND_STATUS)"
          else
            echo "⚠️  Backend health check returned HTTP $BACKEND_STATUS"
            echo "Checking if service is running..."
            ssh vps "sudo systemctl status baytaek-api --no-pager | head -20"
            echo "Checking logs..."
            ssh vps "sudo journalctl -u baytaek-api -n 50 --no-pager"
            # Don't fail deployment - let it continue
          fi

          # Check frontend
          FRONTEND_STATUS=$(ssh vps 'curl -s -o /dev/null -w "%{http_code}" http://localhost || echo "000"')

          if [ "$FRONTEND_STATUS" = "200" ] || [ "$FRONTEND_STATUS" = "301" ] || [ "$FRONTEND_STATUS" = "302" ]; then
            echo "✅ Frontend is accessible (HTTP $FRONTEND_STATUS)"
          else
            echo "⚠️  Frontend returned HTTP $FRONTEND_STATUS (may not be configured yet)"
          fi

      - name: Cleanup old backups
        run: |
          ssh vps "
            # Keep only last 5 backups
            cd /var/www/baytaek
            ls -t | grep 'backend.backup' | tail -n +6 | xargs -r sudo rm -rf
            ls -t | grep 'dist.backup' | tail -n +6 | xargs -r sudo rm -rf
          "

      - name: Send deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed!"
          fi

  # Job 4: Rollback (manual trigger)
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          cat >> ~/.ssh/config <<EOF
          Host vps
            HostName ${{ secrets.VPS_HOST }}
            User ${{ secrets.VPS_USER }}
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF
          chmod 600 ~/.ssh/config

      - name: Rollback Backend
        run: |
          ssh vps "
            # Find latest backup
            LATEST_BACKUP=\$(ls -t /var/www/baytaek/ | grep 'backend.backup' | head -1)

            if [ -z \"\$LATEST_BACKUP\" ]; then
              echo 'No backup found!'
              exit 1
            fi

            # Stop service
            sudo systemctl stop baytaek-api

            # Restore backup
            sudo rm -rf /var/www/baytaek/backend
            sudo cp -r /var/www/baytaek/\$LATEST_BACKUP /var/www/baytaek/backend

            # Start service
            sudo systemctl start baytaek-api
          "

      - name: Rollback Frontend
        run: |
          ssh vps "
            # Find latest backup
            LATEST_BACKUP=\$(ls -t /var/www/baytaek/frontend/ | grep 'dist.backup' | head -1)

            if [ -z \"\$LATEST_BACKUP\" ]; then
              echo 'No backup found!'
              exit 1
            fi

            # Restore backup
            sudo rm -rf /var/www/baytaek/frontend/dist
            sudo cp -r /var/www/baytaek/frontend/\$LATEST_BACKUP /var/www/baytaek/frontend/dist

            # Reload Nginx
            sudo systemctl reload nginx
          "
